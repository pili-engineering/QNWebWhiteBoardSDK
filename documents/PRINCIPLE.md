本文简单介绍七牛白板的技术原理和工作流程。

## 实现技术

* 七牛白板的客户端内核是使用c++编写并使用OpenGL绘制的跨平台白板引擎，所有的数据处理，手势交互，内容渲染等均由c++内核完成。平台相关部分仅做接口和事件对接，同时为内核提供部分系统能力。由于一致的处理逻辑和渲染方式，七牛白板在不同平台不同客户端会呈现完全一致的画面内容。

* 新的SDK分离了房间和白板的概念，用户需要先创建房间，然后在房间中创建白板，一个房间中可以创建多个白板，创建工作仅提供服务端接口。
* 客户端SDK需要先加入房间，然后再打开白板，目前同一时间仅能打开一个白板，可以先关闭旧白板再打开新白板来实现白板切换。
* 目前可创建的白板类型有三种：
  1. 标准白板，不包含文件，仅提供标准画板功能。
  2. ppt演示模式，下层为独占ppt，居中撑满整个窗口，上层为标准画板，支持基础的ppt动画播放和控制。
  3. pdf卷轴模式，下层为独占pdf，居中撑满整个窗口可滚动，上层为标准画板。

* 新的文件系统（ppt演示模式和pdf卷轴模式）以独占方式工作，客户端文件渲染与白板绘制层分离，由一个容器包裹上下两层实现，下层为文件显示层，上层为白板渲染层。文件的上传与转换工作彻底从客户端SDK分离并移除，统一由用户服务器与SDK服务器来完成。客户端SDK不再提供文件插入功能。
* 新的文件系统中一个白板中只能有一个独占文件，且不可动态切换文件，仅能在创建白板时指定对应文件。用户如果需要实现文件切换，必须为每个文件创建对应的白板，然后客户端通过切换白板来实现文件切换。
* 在新SDK流程中，白板对应的程序代码符号为bucket，在服务端和客户端使用`bucketId`来唯一标识一个白板。

## 创建加入房间流程

下图是app集成七牛白板sdk的基本工作流：

![](https://commonshared-paas.oss-cn-beijing.aliyuncs.com/raw/70fe5660-6a56-4860-acb8-199f2c3407f1.jpg)

1. 你的app服务器向七牛白板服务器发起创建房间的请求。
2. 成功创建房间后再向服务器发起在房间中创建白板的请求，同一个房间可以创建多个白板。
3. 如果需要创建带有文件独占模式的白板（当前支持ppt演示模式和pdf卷轴模式），需要先发起文件转换请求，成功后携带转换结果信息创建文件类白板。
4. 你的app客户端向你的app服务端发起请求，索要加入房间所需的全部信息，包括房间内存在的白板id（`bucketId`）。
5. 初始化SDK并执行`joinRoom`加入房间。

## SDK架构概览

![](https://commonshared-paas.oss-cn-beijing.aliyuncs.com/raw/695246ef-ee32-4b69-99cb-4f65532fb0d0.jpg)

* C++ Core：跨平台c++内核。
* widget tree：白板渲染的数据模型树。
* draw engine：基于Skia或WebGL实现的白板图形渲染引擎。
* state manager：房间和白板的状态管理。
* user manager：房间成员管理。
* controller：SDK接口控制器。
* file view：文件显示组件，在新的文件系统中，文件的载入和显示由平台组件完成，目前支持ppt演示模式和pdf卷轴模式，均由H5技术实现。

## 新文件与白板渲染层的互动与同步

由于新文件使用平台组件加载和渲染，与白板渲染层分离，不能直接交互和同步渲染。所以本地的文件和白板是通过事件和命令完成同步的。

* 例如命令文件翻页时，需要同时控制文件的翻页和白板渲染层的翻页。
* 监听白板的移动和缩放事件来控制文件的缩放。
* 文件的状态同步使用SDK中的新接口`sendMessage`发送用户自定义同步消息来完成。

文件源默认由sdk服务器管理以远程h5方式加载，url由对应的白板管理。同时也支持由用户动态提供文件源，可以是自己指定的url，也可以是本地缓存好的H5数据。

如果用户需要实现自己的同步文件显示+标注，可以通过在下层放值自己的文件组件，上层覆盖标准画板模式的透明白板层，然后通过同时控制下层和上层来实现自己的可标注文件系统，需要向远端同步文件状态时使用`sendMessage`发送自己定义的数据格式即可。
